// This program is a part of NT MudLIB
// channeld.c
// Written by Lonely@nitan.org

// ¶ÔÓÚ²ÎÊıµÄ½âÊÍ
// msg_speak   ±ê×¼Ëµ»°µÄÌâÍ·
// msg_emote   ¶¯×÷Ëµ»°µÄÌáÍ·£¬²»¶¨ÒåÔò±íÊ¾²»ÄÜÓÃ¶¯×÷
// msg_color   ÆµµÀµÄÑÕÉ«
// name        ÆµµÀµÄÃû³Æ
// only        Ö¸¶¨½ÓÊÜĞÅÏ¢µÄÍæ¼ÒÀàĞÍ
//             sys    :  ÏµÍ³¿ÉÒÔÊ¹ÓÃµÄ£¬Íæ¼Ò¶¼¿ÉÒÔ¿´µ½£¬µ«Íæ¼Ò²»¿ÉÒÔÊ¹ÓÃ
//             wiz    :  appÒÔÉÏ¿ÉÒÔÊ¹ÓÃ¼°¿´µ½
//             arch   :  archÒÔÉÏ¿ÉÒÔÊ¹ÓÃ¼°¿´µ½
//             party  :  °ïÅÉÄÚ²¿Ê¹ÓÃ¼°¿´µ½£¨Î×Ê¦ºÍÖ¸¶¨¿ÉÒÔÊÕ¿´ËùÓĞÆµµÀµÄID¿ÉÒÔ¿´µ½£©
//             family :  ÃÅÅÉÄÚ²¿Ê¹ÓÃ¼°¿´µ½£¨Î×Ê¦ºÍÖ¸¶¨¿ÉÒÔÊÕ¿´ËùÓĞÆµµÀµÄID¿ÉÒÔ¿´µ½£©
//             league :  Í¬ÃËÅÉÄÚ²¿Ê¹ÓÃ¼°¿´µ½£¨Î×Ê¦ºÍÖ¸¶¨¿ÉÒÔÊÕ¿´ËùÓĞÆµµÀµÄID¿ÉÒÔ¿´µ½£©
// name_raw    ÉèÖÃÎª1µÄ»°£¬¸ÃÆµµÀÔÚÍæ¼Ò´÷Ãæ¾ßºóÈÔÈ»È¡ÆäÕæÊµĞÕÃû
// need_age    ÉèÖÃÎª1µÄ»°£¬¸ÃÆµµÀÔÚÍæ¼Ò18ËêÖ®Ç°ÎŞ·¨Ê¹ÓÃ
// omit_log    ÉèÖÃÎª1µÄ»°£¬²»¼ÇÂ¼ÁÄÌì¼ÇÂ¼
// filter      Ö¸¶¨Ìõ¼şµÄ½ÓÊÕÀàĞÍ
// for_listen  Íæ¼ÒÖ»¿ÉÒÔ¿´µ½¶ø²»¿ÉÒÔÊ¹ÓÃ

#pragma optimize
#pragma save_binary

#include <ansi.h>
#include <mudlib.h>
#include <net/dns.h>
#include <net/macros.h>
#include <localtime.h>

inherit F_DBASE;

#define ALLOW_LIST ({ })
#define SPECIAL_NPC     ({ "/adm/npc/youxun" })

#define REMOTE_Q    "/adm/daemons/network/services/remote_q.c"

string remove_addresses(string, int all);
int filter_listener(object ppl, string only, object me);
protected int check_bad_words(object user, string msg);

nosave string msg_log;
nosave int log_from;

string *bad_words = ({
       "ÈÕÄã", "²ÙÄã", "¸ÉÄã", "ÈÕËÀ", "²ÙËÀ", "¸ÉËÀ", "¹·ÈÕ", "ÈÕ³öÀ´",
       "riÄã", "caoÄã", "ganÄã", "riËÀ", "caoËÀ", "ganËÀ", "¹·ri", "ri³öÀ´",
       "ÎÒ²Ù", "fuck", "¼¦°Í", "¸ØÃÅ", "ĞÔ½»", "ĞóÉú", "Ç¿¼é",
       "¸Ø½»", "·¨ÂÖ¹¦","²åËÀ", "¸É³öÀ´", "gan³öÀ´", "¹·Äï", "ÔÓÖÖ", "×ÔÎ¿",
       "Ä¸¹·", "×æ×ÚÊ®°Ë", "ÂèµÄ¸ö±Æ","ÂèµÄ±Æ", "Âè¸ö±Æ",
       "Âè±Æ", "±ÆÑøµÄ", "Ğ¡±Æ", "ÂèµÄ¸öb", "ÂèµÄb", "Âè¸öb", "Âèb", "É§»õ",
       "bÑøµÄ", "ÄãÂèÉú", "ÒõµÀ", "Òõ»§", "ÒõµÙ", "Òõ¾¥", "¹êÍ·",
       "ÂÑµ°", "¹·Äï", "ÎÚ¹êÍõ°Ë", "Éµ±Æ", "Éµb", "sb", "×ö°®", "ÒâÒù",
       "ÂÖ¼é", "ÔÓ½»", "ÂèÂèµÄ", "bitch", "ĞÔ°®", "ŒÂ", "ÚP", "åş",
       "ÃH", "åê", "ŒÅ", "µõÄã", "¹­ËäÅ®¸É"
});

string query_msg_log() { return msg_log; }

mapping channels = ([
        "sys":  ([      "msg_speak": HIR "¡¾ÏµÍ³±¨¸æ¡¿%s£º%s\n" NOR,
                        "msg_emote": HIR "¡¾ÏµÍ³±¨¸æ¡¿%s" NOR,
                        "msg_color": HIR,
                        "only"     : "imm",
                        "name"     : "ÏµÍ³",
                        "omit_log" : 1,
                        "name_raw" : 1,
                ]),

        "wiz":  ([      "msg_speak": HIG "¡¾Î×Ê¦ÆµµÀ¡¿%s£º%s\n" NOR,
                        "msg_emote": HIG "¡¾Î×Ê¦ÆµµÀ¡¿%s" NOR,
                        "msg_color": HIG,
                        "name"     : "Î×Ê¦",
                        "only"     : "imm",
                        "intermud" : GCHANNEL,
                        "intermud_emote"   : 1,
                        "intermud_channel" : "wiz",
                        "omit_address": 0,
                        "omit_log" : 1,
                        "name_raw" : 1,
                        "filter"   : (: $1["MUDLIB"] == MUDLIB_NAME :)
                ]),

        "gwiz": ([      "msg_speak": HIG "¡¾Íø¼ÊÎ×Ê¦¡¿%s£º%s\n" NOR,
                        "msg_emote": HIG "¡¾Íø¼ÊÎ×Ê¦¡¿%s" NOR,
                        "msg_color": HIG,
                        "name"     : "½»Á÷",
                        "only"     : "imm",
                        "intermud" : GCHANNEL,
                        "intermud_emote"   : 1,
                        "intermud_channel" : "gwiz",
                        "omit_address"     : 0,
                        "omit_log" : 1,
                        "name_raw" : 1,
                        //"filter"   : 1,
                ]),

        "debug":([      "msg_speak": HIW "¡¾µ÷ÊÔĞÅÏ¢¡¿%s£º%s\n" NOR,
                        "msg_emote": HIW "¡¾µ÷ÊÔĞÅÏ¢¡¿%s" NOR,
                        "msg_color": HIW,
                        "name"     : "µ÷ÊÔ",
                        "only"     : "wiz",
                        "omit_log" : 1,
                        "name_raw" : 1,
                ]),

        "war": ([       "msg_speak": HIR "¡¾Õ½ÕùÆµµÀ¡¿%s£º%s\n" NOR,
                        "msg_emote": HIR "¡¾Õ½ÕùÆµµÀ¡¿%s" NOR,
                        "msg_color": HIR,
                        "name"     : "ÈÎÎñ",
                        //"only"     : "npc",
                        "omit_log" : 1,
                        "name_raw" : 1,
                ]),

        "inter":([      "msg_speak": HIR "¡¾Í¬ÃË½»Ì¸¡¿%s£º%s\n" NOR,
                        "msg_emote": HIR "¡¾Í¬ÃË½»Ì¸¡¿%s" NOR,
                        "msg_color": HIR,
                        "only"     : "league",
                        "name_raw" : 1,
                        "name"     : "Í¬ÃË",
                        "omit_log" : 1,
                ]),

        "chat": ([      "msg_speak": HIC "¡¾ÂÛµÀ½­ºş¡¿%s£º%s\n" NOR,
                        "msg_emote": HIC "¡¾ÂÛµÀ½­ºş¡¿%s" NOR,
                        "msg_color": HIC,
                        "name"     : "ÏĞÁÄ",
                ]),

        "new": ([       "msg_speak": HIC+"¡¾"+HIW+"³õÈë½­ºş"+HIC+"¡¿%s£º%s\n" NOR,
                        "msg_emote": CYN+"¡¾"+HIY+"³õÈë½­ºş"+CYN+"¡¿"+HIC+"%s" NOR,
                        "msg_color": NOR+HIC,
                        "name"     : "ĞÂÊÖ",

                ]),

        "rumor":([      "msg_speak": HIM "¡¾Ò¥ÑÔËÄÆğ¡¿%s£º%s\n" NOR,
                        "msg_emote": HIM "¡¾Ò¥ÑÔËÄÆğ¡¿%s" NOR,
                        "msg_color": HIM,
                        "name"     : "Ò¥ÑÔ",
                        "anonymous": "Ä³ÈË",
                ]),

        "ultra": ([     "msg_speak": HIW "¡¾´ó ×Ú Ê¦¡¿%s£º%s\n" NOR,
                        "msg_emote": HIW "¡¾´ó ×Ú Ê¦¡¿%s" NOR,
                        "msg_color": HIW,
                        "name"     : "´ó×ÚÊ¦",
                        "intermud" : GCHANNEL,
                        "intermud_emote"    : 1,
                        "intermud_channel"  : "rultra",
                        "filter"   : (: $1["MUDLIB"] == MUDLIB_NAME :)
                ]),

        "info": ([      "msg_speak": WHT "¡¾ĞÅÏ¢ÆµµÀ¡¿%s£º%s\n" NOR,
                        "msg_color": WHT,
                        "name"     : "ĞÅÏ¢",
                        //"only"     : "sys",
                        "omit_log" : 1,
                        "for_listen": 1,
                ]),

        "shout":([      "msg_speak": HIW "%s×İÉù³¤Ğ¥£º%s\n" NOR,
                ]),

        "sing":  ([     "msg_speak": CYN "¡¾»¶¸èĞ¦Óï¡¿%s³ªÖø£º%s\n" NOR,
                        "msg_color": CYN,
                        "name"     : "¸è³ª",
                 ]),
        "stock":([      "msg_speak": RED "¡¾¹ÉÆ±ÆµµÀ¡¿%s£º%s\n" NOR,
                        "msg_color": RED,
                        "name"     : "¹ÉÆ±",
                        //"only"     : "sys",
                        "omit_log" : 1,
                        "for_listen": 1,
                ]),

        "sos":  ([      "msg_speak": HIG "¡¾½­ºş¸æ¼±¡¿%s£º%s\n" NOR,
                        "msg_color": HIG,
                        "name_raw" : 1,
                        "name"     : "ÇóÖú",
                ]),

        "family":([     "msg_speak": HIG "¡¾Í¬ÃÅ»°Óï¡¿%s£º%s\n" NOR,
                        "msg_emote": HIG "¡¾Í¬ÃÅ»°Óï¡¿%s" NOR,
                        "msg_color": HIG,
                        "only"     : "family",
                        "name"     : "Í¬ÃÅ",
                        "omit_log" : 1,
                ]),

        "party":([      "msg_speak": HIG "¡¾±¾°ï»°Óï¡¿%s£º%s\n" NOR,
                        "msg_emote": HIG "¡¾±¾°ï»°Óï¡¿%s" NOR,
                        "msg_color": HIG,
                        "only"     : "party",
                        "name"     : "°ïÅÉ",
                        "omit_log" : 1,
                ]),

        "bt":([         "msg_speak": HIG "¡¾Õ½³¡»°Óï¡¿%s£º%s\n" NOR,
                        "msg_emote": HIG "¡¾Õ½³¡»°Óï¡¿%s" NOR,
                        "msg_color": HIG,
                        "only"     : "bt",
                        "name"     : "Õ½³¡",
                        "omit_log" : 1,
                ]),
                
        "rultra":([     "msg_speak": WHT "¡¾ÈûÍâ×ÚÊ¦¡¿%s£º%s\n" NOR,
                        "msg_emote": WHT "¡¾ÈûÍâ×ÚÊ¦¡¿%s" NOR,
                        "msg_color": WHT,
                        "name"     : "ÈûÍâ×ÚÊ¦",
                        "for_listen": 1,
                ]),

        "nt":   ([      "msg_speak": HIC "¡¾ÒìÓò´«ÎÅ¡¿%s£º%s\n" NOR,
                        "msg_emote": HIC "¡¾ÒìÓò´«ÎÅ¡¿%s" NOR,
                        "msg_color": HIC,
                        "intermud" : GCHANNEL,
                        "intermud_emote"   : 1,
                        "intermud_channel" : "nt",
                        "name"     : "ÒìÓò",
                        "name_raw" : 1,
                        "filter"   : (: $1["MUDLIB"] == MUDLIB_NAME :)
                ]),

        "es":   ([      "msg_speak": HIC "¡¾Íø¼Ê´«Çé¡¿%s£º%s\n" NOR,
                        "msg_emote": HIC "¡¾Íø¼Ê´«Çé¡¿%s" NOR,
                        "msg_color": HIC,
                        "intermud" : GCHANNEL,
                        "intermud_emote"   : 1,
                        "intermud_channel" : "es",
                        "name"     : "Íø¼Ê",
                        //"filter"   : 1,
                        // "need_age" : 1,
                        "name_raw" : 1,
                        "omit_address"     : 0,
                 ]),

        "bill":  ([     "msg_speak": HIY "¡¾½»Ò×ÆµµÀ¡¿%s£º%s\n" NOR,
                        "msg_color": HIY,
                        "name"     : "½»Ò×",
                        "name_raw" : 1,
                        "omit_log" : 1,
                 ]),

]);

void create()
{
        // This is required to pass intermud access check.
        seteuid(getuid());
        set("channel_id", "ÆµµÀ¾«Áé");
}

mapping query_chann() {        return channels; }

void channel_log(string msg, string verb, object user)
{
        string lfn;
        mixed lt;
        int t;

        if( !mapp(channels[verb]) || !objectp(user) || !userp(user) )
                return;

        if( channels[verb]["omit_log"] )
                return;

        if( !stringp(msg_log) ) msg_log = "";

        t = time();
        msg_log += sprintf(" %s(%s) on %s\n%s",
                           user->name(1),query("id", user),log_time(),filter_color(msg));
        if( strlen(msg_log) > 8000 || t - log_from > 900 ) {
                lt = localtime(t);

                lfn = sprintf("channel/%d-%d-%d", lt[LT_YEAR],
                              lt[LT_MON] + 1, lt[LT_MDAY]);
                assure_file(LOG_DIR + lfn);
                log_file(lfn, msg_log);
                msg_log = "";
                log_from = t;
        }
}

// ½ÓÊÕREMOTE_Q·µ»ØÀ´µÄĞÅÏ¢²¢ÏÔÊ¾Ö®
void do_remote_channel(object me, string verb, string arg)
{
        object *obs;
        string msg;

        if( undefinedp(channels[verb]) || !userp(me) )
                return;

        // Ok, I will direct send the message to those people listening us.
        obs = all_interactive();
        if( stringp(channels[verb]["only"]) )
                obs = filter_array(obs, (: filter_listener :),
                                   channels[verb]["only"], me);

        msg = sprintf(channels[verb]["msg_emote"], arg);
        message("channel:" + verb, msg, obs);
        channel_log(msg, verb, me);
        obs->add_msg_log(verb, msg + "\n");

        // Ïò¸÷¸öÕ¾µã·¢ËÍEMOTEĞÅÏ¢
        channels[verb]["intermud"]->send_msg(channels[verb]["intermud_channel"],
                                             query("id", me),me->name(1),
                                             arg, 1,
                                             channels[verb]["filter"]);
}


varargs int do_channel(object me, string verb, string arg, int emote)
{
        object *obs;
        string *tuned_ch, who;
        int is_player, myemote;
        string imsg = 0, local;
        string msg;
        object *tobs;
        object tplayer;
        object *pobs;

        string bt;
        string party;
        string family;
        string fname;

        string self_emote;

        self_emote = arg;

        // Check if this is a channel emote.
        if( sizeof(verb) > 2 ) {
                if( verb[sizeof(verb)-1] == '*' ) {
                        emote = 1;
                        verb = verb[0..<2];
                } else
                if( verb[sizeof(verb)-1] == '#' ) {
                        myemote = 1;
                        verb = verb[0..<2];
                }
        }

        if( !wizardp(me) && arg && strlen(arg) > 350 ) {
                CHANNEL_D->do_channel(this_object(),"sys",query("name", me)+"("+query("id", me)+")ÆóÍ¼Flood»Ù»µ¹«¹²ÆµµÀ£¡\n");
                return 1;
        }

        // Check if this is a channel messsage.
        if( !mapp(channels) || undefinedp(channels[verb]) ) return 0;

        if( me->is_chatter() )
                return notify_fail("ÁÄÌì»êÆÇÄ¿Ç°²»ÄÜÊ¹ÓÃ¸÷ÖÖÆµµÀ¡£\n");

        is_player = playerp(me);
        if( is_player && ! wizardp(me) ) {
//if( !query("registered", me) )
//                        return notify_fail("Äã±ØĞëÔÚ×¢²áÒÔºó²ÅÄÜ¹»Ê¹ÓÃ¸÷ÖÖÆµµÀ¡£\n");

//query("mud_age", if( me)1800 && me-query("monfee")<11 )
//                        return notify_fail("Äã±ØĞëÔÚÍê³É×¢²áÎå·ÖÖÓÒÔºó²ÅÄÜÊ¹ÓÃÆµµÀ£¬Õâ¶Î"
//                                           "Ê±¼äÄÚÇëÏÈÔÄ¶Á°ïÖú(help newbie)¡£\n")

                if( channels[verb]["need_age"] && query("age", me)<18 )
                        return notify_fail("Äã±ØĞë³ÉÄêÒÔºó²ÅÄÜÊ¹ÓÃ" + channels[verb]["name"] +
                                           "ÆµµÀ¡£\n");
        }

        //now we can be sure it's indeed a channel message:
        if( !stringp(arg) || arg == "" || arg == " " )
                arg = "...";

        if( ultrap(me) ) {
                if( verb == "chat" && ! query("env/no_autoultra", me) )
                        verb = "ultra";
        } else
                if( is_player && verb == "ultra" )
                        return notify_fail("µÈÄã³ÉÁË´ó×ÚÊ¦ÔÙ"
                                           "Ê¹ÓÃÕâ¸öÆµµÀ°É£¡\n");

        // player broadcasting need consume jing
        if( playerp(me) && !wizardp(me) && verb == "rumor" &&
            !objectp(present("rumor generator", me)) )
                if( query("jing", me)>50)me->add("jing",-random(36) )
                        ; else
                return notify_fail("ÄãÒÑ¾­Ã»Á¦ÆøÉ¢²¥Ò¥ÑÔÁË£¡\n");

        if( playerp(me) && me->ban_say(1) ) return 0;

        // check if rumor or chat is blocked
        if( query("chblk_on", me) )
                return notify_fail("ÄãµÄÁÄÌìÆµµÀ¸ø¹Ø±ÕÁË£¡Î¨Ò»µÄ°ì·¨¾ÍÊÇÇëÇóÔÚÏßÍæ¼ÒÍ¶Æ±¿ªÍ¨¡£\n");

        if( query("doing", me) == "scheme"){
                if( query("jing", me)<100 )
                        return notify_fail("ÄãÏÖÔÚµÄ¾«Éñ²»¼Ã£¬µÈÒ»»á¶ù°É¡£\n");
                addn("jing", -50, me);
        }

        if (me->is_character() && living(me))
        {
                if( time()-query_temp("last_use_channel", me)<4){
                        if( query_temp("last_message", me) == arg )
                                return notify_fail("²»ÒªÔÚ¶ÌÆÚÄÚÊ¹ÓÃÆµµÀ"
                                                   "·¢²¼ÖØ¸´µÄĞÅÏ¢¡£\n");
                        set_temp("last_message", arg, me);
                } else {
                        set_temp("last_message", arg, me);
                        set_temp("last_use_channel", time(), me);
                }

                switch (channels[verb]["only"])
                {
                case "imm":
                        if( wiz_level(me) < 1 )
                                return 0;
                        break;

                case "wiz":
                        if( wiz_level(me) < 3 )
                                return 0;
                        break;

                case "arch":
                        if( wiz_level(me) < 4 )
                                return 0;
                        break;
                case "sys" :
                        if( playerp(me) )
                                return 0;
                        break;

                case "party":
                        if( !(party=query("bunch/bunch_name", me)) )
                                return notify_fail("Äã»¹ÊÇÏÈ¼ÓÈëÒ»¸ö°ïÅÉÔÙËµ°É¡£\n");

                        if( strlen(party) == 4 ) {
                                party = party[0..1] + " £  " +
                                        party[2..3];
                        }

                        if( strlen(party) == 6 ) {
                                party = party[0..1] + " " +
                                        party[2..3] + " " +
                                        party[4..5];
                        }
                        channels[verb]["msg_speak"] = HIG "¡¾" + party +
                                                      "¡¿%s£º%s\n" NOR;
                        channels[verb]["msg_emote"] = HIG "¡¾" + party +
                                                      "¡¿%s" NOR;
                        break;

                case "bt":
                        if( !(bt=query_temp("battle/team_name", me)) )
                                return notify_fail("Äã»¹ÊÇÏÈ²Î¼ÓÕ½³¡ÔÙËµ°É¡£\n");

                        if( strlen(bt) == 4 ) {
                                bt = bt[0..1] + " £  " +
                                     bt[2..3];
                        }

                        if( strlen(bt) == 6 ) {
                                bt = bt[0..1] + " " +
                                     bt[2..3] + " " +
                                     bt[4..5];
                        }
                        channels[verb]["msg_speak"] = HIG "¡¾" + bt +
                                                      "¡¿%s£º%s\n" NOR;
                        channels[verb]["msg_emote"] = HIG "¡¾" + bt +
                                                      "¡¿%s" NOR;
                        break;
                        
                case "family":
                        if( !(family=query("family/family_name", me)) )
                                return notify_fail("Äã»¹ÊÇÏÈ¼ÓÈëÒ»¸öÃÅÅÉÔÙËµ°É¡£\n");

                        if( strlen(family) == 4 ) {
                                family = family[0..1] + " £  " +
                                         family[2..3];
                        }

                        if( strlen(family) == 6 ) {
                                family = family[0..1] + " " +
                                         family[2..3] + " " +
                                         family[4..5];
                        }
                        channels[verb]["msg_speak"] = HIG "¡¾" + family +
                                                      "¡¿%s£º%s\n" NOR;
                        channels[verb]["msg_emote"] = HIG "¡¾" + family +
                                                      "¡¿%s" NOR;
                        break;
                }
        }

        if( verb == "shout" ) {
                if( !arg ) return notify_fail("ÄãÏëÒª´ó½ĞÊ²Ã´£¿\n");

                if( !wizardp(me) )
                        return notify_fail("Äã²»ÊÇÎ×Ê¦£¬ÎŞ·¨º°³öÄÇÃ´´óµÄÉùÒô¡£\n");

                who = me->name(1) + "[" + query("id", me) + "]";
                msg = sprintf(channels[verb]["msg_speak"], who, arg);
                // msg = HIW + me->name(1) + "×İÉù³¤Ğ¥£º" + arg + "\n" + NOR;
                shout(msg);
                write(HIW + "Äã×İÉù³¤Ğ¥£º" + arg + "\n" + NOR);
                channel_log(msg, verb, me);
                users()->add_msg_log(verb, msg + "\n");
                return 1;
        }

        // If we speaks something in this channel, then must tune it in.
        if( playerp(me) ) {
                if( !pointerp(tuned_ch=query("channels", me))){
                        set("channels", ({verb}), me);
                        write("Äã´ò¿ªÁË" + channels[verb]["name"] + "ÆµµÀ¡£\n");
                } else
                if( member_array(verb, tuned_ch) == -1 ) {
                        set("channels", tuned_ch+({verb}), me);
                        write("Äã´ò¿ªÁË" + channels[verb]["name"] + "ÆµµÀ¡£\n");
                }

                if( channels[verb]["for_listen"] ) {
                        write("Õâ¸öÆµµÀÖ»ÄÜÓÃÀ´ÌıÈ¡ĞÅÏ¢¡£\n");
                        return 1;
                }
        }

        // Support of channel emote
        if( emote  && me->is_character() ) {
                string vb, emote_arg, mud;

                if( undefinedp(channels[verb]["msg_emote"]) )
                        return notify_fail("Õâ¸öÆµµÀ²»Ö§³Ö±íÇé¶¯´Ê¡£\n");

                if( sscanf(arg, "%s %s", vb, emote_arg) != 2 ) {
                        vb = arg;
                        emote_arg = "";
                }

                // internet channel emote
                if( channels[verb]["intermud_emote"] ) {
                        if( sscanf(emote_arg, "%s@%s", emote_arg, mud) == 2 &&
                            htonn(mud) != mud_nname() ) {
                                REMOTE_Q->send_remote_q(mud,verb,query("id", me),emote_arg,vb);
                                write("ÍøÂ·Ñ¶Ï¢ÒÑËÍ³ö£¬ÇëÉÔºò¡£\n");
                                return 1;
                        }

                        local=sprintf("%s(%s@%s)",me->name(1),capitalize(query("id", me)),
                                                     upper_case(MUD_INTERMUD_NAME));
                        imsg = EMOTE_D->do_emote(me, vb, emote_arg, 3, local,
                                                 channels[verb]["msg_color"]);
                        if( stringp(imsg) )
                                arg = replace_string(imsg, local, me->name());
                        else
                                arg = 0;
                }
                else if( verb == "rumor" && random(10) < 7 )
                        arg = EMOTE_D->do_emote(me, vb, emote_arg, 2,
                                        channels[verb]["anonymous"],
                                        channels[verb]["msg_color"]);
                else    arg = EMOTE_D->do_emote(me, vb, emote_arg, 1,
                                        0, channels[verb]["msg_color"]);

                if( !arg && emote == 2 )
                        arg = (channels[verb]["anonymous"] ? channels[verb]["anonymous"]
                                                           : me->name(channels[verb]["name_raw"])) +
                                                             vb + "\n";
                if( !arg )
                        return 0;
        }

        if( myemote && me->is_character() ) {
                if( undefinedp(channels[verb]["msg_emote"]) )
                        return notify_fail("Õâ¸öÆµµÀ²»Ö§³Ö×Ô¶¨Òå±íÇé¡£\n");

                // internet channel emote
                if( channels[verb]["intermud_emote"] )
                        return notify_fail("Õâ¸öÆµµÀ²»Ö§³Ö×Ô¶¨Òå±íÇé¡£\n");

                if( stringp(arg) &&
                    ((strsrch(arg, "[") != -1) ||
                     (strsrch(arg, "]") != -1)) )
                        return notify_fail("Õâ¸öÆµµÀ½ûÖ¹Ê¹ÓÃ¡®[¡¯¡¢¡®]¡¯µÈ×Ö·û¡£\n");
        }

        if( channels[verb]["anonymous"] && ( !playerp(me) || emote || check_bad_words(me, arg)) ) {
                who = channels[verb]["anonymous"];
        } else
        if( is_player || !stringp(who=query("channel_id", me))){
                who = me->name(channels[verb]["name_raw"]);
                if( !stringp(who) ) who = me->query_name();
                if( who == me->name(1) )
                        who += channels[verb]["msg_color"] +
                               "[" + capitalize(query("id", me)) + "]";
                else if( is_player || me->is_baby() )
                        do_channel(this_object(),"sys",sprintf(HIW"%s(%s)"HIW"°ç%s"HIW"£¡",me->name(1),query("id", me),me->name()));
                if( who[0] == 27 ) who = NOR + who;
                who += channels[verb]["msg_color"];
        }

        // Ok, now send the message to those people listening us.
        obs = all_interactive();
        if (stringp(channels[verb]["only"]))
                obs = filter_array(obs, (: filter_listener :),
                                   channels[verb]["only"], me);

        //if( !stringp(arg) || arg == "" || arg == " " )
        arg = arg || (emote ? "¿´ÆğÀ´±íÇé·á¸»¡£" : "..." );

        if( emote ) {
                string localmsg = arg;
                string ecol = channels[verb]["msg_color"];
                if( emote == 2 && !arg )
                        arg = me->name(channels[verb]["name_raw"]) +
                              ecol+"["+query("id", me)+"@"+
                              MUD_INTERMUD_NAME + "]" + arg;
                if( !stringp(arg) ) return 0;

                if( channels[verb]["msg_emote"] )
                        localmsg = remove_addresses(arg, 0); // 98-1-22 14:30

                if( channels[verb]["omit_address"] )
                        localmsg = remove_addresses(arg, 1);
                else if( channels[verb]["intermud_emote"] )
                        localmsg = remove_addresses(arg, 0);

                if( !stringp(localmsg) ) return 0;
                msg = sprintf(channels[verb]["msg_emote"],
                              sprintf(localmsg, ecol, ecol, ecol));
        } else if( myemote ) {
                if( channels[verb]["anonymous"] && !playerp(me) )
                        arg = channels[verb]["anonymous"] + arg + "\n";
                else
                        arg=query("name", me)+arg+"\n";
                msg = sprintf(channels[verb]["msg_emote"], arg);
        } else {
                // ÌØÊâ´¦Àíchannel_broadcastĞÅÏ¢ÏÔÊ¾
                if( me == this_object() ) {
                        msg = sprintf(channels[verb]["msg_speak"], "", arg);
                        msg = replace_string(msg, "£º", "");
                }
                else
                        msg = sprintf(channels[verb]["msg_speak"], who, arg);
        }

        if( channels[verb]["anonymous"] && (playerp(me) || me->is_baby()) ) {
                do_channel(this_object(), "sys",
                           sprintf("%s(%s)ÕıÔÚÏò%sÆµµÀ·¢³öĞÅÏ¢¡£",
                              query("name", me),query("id", me),verb));
                SPECIAL_NPC->receive_report(me, verb);
        }

        tobs = filter_array(obs, (: query_temp("tomud", $1) :));
        pobs = obs - tobs;
        message("channel:" + ((verb == "ultra") ? "chat" : verb), msg, pobs);
        msg = replace_string(msg, "\n[2;37;0m", "");
        msg += NOR;
        message("channel:" + ((verb == "ultra") ? "chat" : verb), msg, tobs);
        channel_log(msg, verb, me);
        obs->add_msg_log(verb, msg + "\n");

        if( (playerp(me) || me->is_baby()) && !emote && !check_bad_words(me, msg) )
        {
                if( !query("badwords", me) || query("badwords", me)<2 )
                {
                        me->ban_say_until(60, "ÓÉÓÚÄãÑÔÓïÖĞ´øÓĞÎÛ»àÑÔ´Ê£¬ÄãËùÓĞ¹«¿ªÁÄÌìÆµµÀÔİÊ±±»¹Ø±Õ");

                        message("channel:chat",
                                        HIR"¡¾ÏµÍ³Í¨¸æ¡¿Íæ¼Ò"+query("name", me)+
                                        "ÑÔÓïÖĞ´øÓĞÎÛ»àÑÔ´Ê£¬ÔİÊ±¹Ø±ÕÆäËùÓĞ¹«¿ªÁÄÌìÆµµÀ£¬²¢¼ÇÂ¼ÔÚ°¸£¡\n" NOR, users());
                        addn("badwords", 1, me);
                }
                else
                {
                        message("channel:chat",
                                        HIR"¡¾ÏµÍ³Í¨¸æ¡¿Íæ¼Ò"+query("name", me)+
                                        "Á¬ĞøÈı´ÎÑÔÓïÖĞ´øÓĞÎÛ»àÑÔ´Ê£¬±»ÔİÊ±¼à½û£¬²¢¼ÇÂ¼ÔÚ°¸£¬µÈºò´¦Àí£¡\n" NOR, users());
                        delete("badwords", me);
                        me->get_into_prison(0, 0, 180);
                }
        }

        if( arrayp(channels[verb]["extra_listener"]) ) {
                channels[verb]["extra_listener"] -= ({ 0 });
                if( sizeof(channels[verb]["extra_listener"]) )
                        channels[verb]["extra_listener"]->relay_channel(me, verb, arg);
        }

        if( !undefinedp(channels[verb]["intermud"]) && me->is_character() ) {
                channels[verb]["intermud"]->send_msg(channels[verb]["intermud_channel"],
                                                     query("id", me),me->name(1),
                                                     imsg ? imsg : arg, emote,
                                                     channels[verb]["filter"]);
        }

        return 1;
}

int filter_listener(object ppl, string only, object me)
{
        // Don't bother those in the login limbo.
        //if ( !environment(ppl) ) return 0;

        switch (only)
        {
        case "imm":
                return (wiz_level(ppl) >= 1);

        case "arch":
                return (wiz_level(ppl) >= 4);

        case "wiz":
                return (wiz_level(ppl) >= 3);

        case "sys":
                return 1;

        case "family":
                return (wizardp(ppl) || query("family/family_name", ppl) == query("family/family_name", me));

        case "bt":
                return (wizardp(ppl) || query_temp("battle/team_name", ppl) == query_temp("battle_team_name", me));
                
        case "party":
                return (wizardp(ppl) || query("bunch/bunch_name", ppl) == query("bunch/bunch_name", me));

        case "league":
                return (wizardp(ppl) || query("league/league_name", ppl) == query("league/league_name", me));
        }

        return 1;
}

void register_relay_channel(string channel)
{
        object ob;
        ob = previous_object();

        if( undefinedp(channels[channel]) || !ob )
                return;
        if( arrayp(channels[channel]["extra_listener"]) ) {
                if( member_array(ob, channels[channel]["extra_listener"]) >= 0 )
                        return;
                channels[channel]["extra_listener"] += ({ ob });
        }
        else    channels[channel]["extra_listener"] = ({ ob });
}

string remove_addresses(string msg, int all)
{
        int i;
        mixed tmp;
        string pattern;

        if( !stringp(msg) ) return msg;
        if( all )
                pattern = "[(][A-Za-z]+@[a-zA-Z]+[0-9]+[.]?[)]";
        else
                pattern = "[(][A-Za-z]+@" + MUD_INTERMUD_NAME + "[)]";

        tmp = reg_assoc(msg, ({ pattern }), ({ 1 }));

        if( !arrayp(tmp) ) return msg;
        msg = "";
        for( i=0; i<sizeof(tmp[0]); i++ )
                if( tmp[1][i] == 0 ) msg += tmp[0][i];
        return msg;
}

protected int check_bad_words(object user, string msg)
{
        int i;
        string old_msg = msg;

        msg = replace_string(msg,"Òæ»ú","");
        msg = replace_string(msg,"ç¼Ë¿","");
        msg = replace_string(msg,"¹æ»¹","");
        msg = replace_string(msg,"£á","a");
        msg = replace_string(msg,"£â","b");
        msg = replace_string(msg,"£ã","c");
        msg = replace_string(msg,"£ä","d");
        msg = replace_string(msg,"£å","e");
        msg = replace_string(msg,"£æ","f");
        msg = replace_string(msg,"£ç","g");
        msg = replace_string(msg,"£è","h");
        msg = replace_string(msg,"£é","i");
        msg = replace_string(msg,"£ê","j");
        msg = replace_string(msg,"£ë","k");
        msg = replace_string(msg,"£ì","l");
        msg = replace_string(msg,"£í","m");
        msg = replace_string(msg,"£î","n");
        msg = replace_string(msg,"£ï","o");
        msg = replace_string(msg,"£ğ","p");
        msg = replace_string(msg,"£ñ","q");
        msg = replace_string(msg,"£ò","r");
        msg = replace_string(msg,"£ó","s");
        msg = replace_string(msg,"£ô","t");
        msg = replace_string(msg,"£õ","u");
        msg = replace_string(msg,"£ö","v");
        msg = replace_string(msg,"£÷","w");
        msg = replace_string(msg,"£ø","x");
        msg = replace_string(msg,"£ù","y");
        msg = replace_string(msg,"£ú","z");
/*
        msg = lower_case(msg);
        msg = replace_string(msg,",","");
        msg = replace_string(msg,".","");
        msg = replace_string(msg,";","");
        msg = replace_string(msg,"£¬","");
        msg = replace_string(msg,"¡£","");
        msg = replace_string(msg,"£»","");
        msg = replace_string(msg," ","");
        msg = replace_string(msg,"£ ","");
        msg = replace_string(msg,"'","");
        msg = replace_string(msg,"\"","");
        msg = replace_string(msg,"¡±","");
        msg = replace_string(msg,"¡°","");
        msg = replace_string(msg,"[","");
        msg = replace_string(msg,"]","");
        msg = replace_string(msg,"¡º","");
        msg = replace_string(msg,"¡»","");
        msg = replace_string(msg,"¡¾","");
        msg = replace_string(msg,"¡¿","");
        msg = replace_string(msg,"¡¯","");
        msg = replace_string(msg,"¡®","");
*/

        for( i = 0; i < sizeof(bad_words);i ++ )
        {
                if( strsrch(msg, bad_words[i]) != -1 )
                {
                        log_file("channel/bad_word",sprintf("%s(%s)ÓÚ%sÉæÏÓ½²Ôà»°£º\n%s-->%s\n",
                                                             user->name(1),
                                                             query("id", user),
                                                             ctime(time()),
                                                             filter_color(old_msg),
                                                             bad_words[i]) );
                        return 0;
                }
        }
        return 1;
}

varargs void channel_broadcast(string channel, string msg, mixed arg)
{
        if( undefinedp(arg) )
                do_channel(this_object(), channel, msg);
        else if( objectp(arg) )
                do_channel(arg, channel, msg);
        else
                do_channel(this_object(), channel, msg, arg);
}
